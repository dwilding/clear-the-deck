<!doctype html>
<html lang="en-gb">
	<head>
		<meta charset="utf-8">
		<title>Clear the deck</title>
		<meta name="description" content="Discover integer sequences by dealing cards.">
		<meta name="author" content="Dave Wilding">
		<link rel="stylesheet" href="default.css">
		<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
		<script src="viewport-min.js"></script>
		<script src="sequences-min.js"></script>
	</head>
	<body>
		<div id="container">
			<h1>Clear the deck</h1>
			<p class="float-right big">
				<a class="image" href="https://github.com/dwilding/clear-the-deck" title="GitHub"><img alt="GitHub" src="github.png"></a>
			</p>
			<div class="clear"></div>
			<p class="row col-left float-left">
				Discover integer sequences by dealing cards.
			</p>
			<div class="row col-right float-left">
				<div class="box">
					<h2>Your deal</h2>
					<div id="deal-border" class="textbox unselected">
						<input id="deal" type="text">
					</div>
					<p class="float-left small">
						<span id="example" role="button" tabindex="0">Show me an example</span>
					</p>
					<p class="float-right small">
						Status: <span id="status"></span>
					</p>
					<div class="clear"></div>
				</div>
			</div>
			<div class="clear"></div>
			<p id="info" class="row col-left float-left">
			</p>
			<div class="row col-right float-left">
				<ol id="list" start="0">
				</ol>
			</div>
			<div id="bottom" class="clear"></div>
		</div>
		<script>
var example = 0,
examples = [
	'1',
	'2',
	'1 2',
	'0 or 3',
	'1 or 3',
	'3 or 3',
	'8*1',
	'1^4',
	'1^2-4',
	'1^?',
	'...'
],
known = {
	'(1)^?': 'You have found <a href="http://oeis.org/A000012">A000012</a>!'
};

var elDeal, elDealBorder, elExample, elStatus, elInfo, elList, elBottom,
str = null,
seq = null;

$(document).ready(function () {
	elDeal = $('#deal');
	elDealBorder = $('#deal-border');
	elExample = $('#example');
	elStatus = $('#status');
	elInfo = $('#info');
	elList = $('#list');
	elBottom = $('#bottom');

	elDeal.focus(function () {
		elDealBorder.removeClass('unselected').addClass('selected');
	});
	elDeal.focusout(function () {
		elDealBorder.removeClass('selected').addClass('unselected');
	});
	elDeal.keyup(refreshSequence);
	elDeal.change(refreshSequence);
	elExample.click(function() {
		if (example == examples.length - 1) {
			elExample.remove();
		}
		elDeal.val(examples[example]);
		refreshSequence();
		elExample.html('Show me another example');
		example++;
	});
	$(window).scroll(function () {
		if (elBottom.is(':in-viewport')) {
			if (seq == null) {
				listDummy();
			}
			else {
				listSequence();
			}
		}
	});
	$(window).bind('hashchange', useHash);
	useHash();
});

function refreshSequence() {
	if (str == elDeal.val()) {
		return;
	}
	str = elDeal.val();
	try {
		seq = new Sequence(str);
	}
	catch(e) {
		elStatus.text('A' + (e.i + 1).toString());
		rejectSequence('');
		return;
	}
	location.hash = '#' + encodeURIComponent(str);
	try {
		seq.build();
	}
	catch(e) {
		elStatus.html('B' + e.toString());
		rejectSequence('Your deal <a href="#0%5E0-1">does</a> ' +
		'<a href="#0%5E0-2">not</a> <a href="#0%5E0-3">make</a> ' +
		'<a href="#0%5E0-4">sense</a>!');
		return;
	}
	elStatus.html('C' + seq.machine.states.toString());
	elList.html('');
	identifySequence(listSequence());
}

function rejectSequence(reason) {
	seq = null;
	elList.html('');
	listDummy();
	elInfo.html(reason);
}

function listDummy() {
	var i;

	for (i = 0; i < 12 || elBottom.is(':in-viewport'); i++) {
		elList.append('<li></li>');
	}
}

function listSequence() {
	var i,
	items = [];

	for (i = 0; i < 12 || elBottom.is(':in-viewport'); i++) {
		items.push(seq.next().toString());
		elList.append('<li><span class="num">' + items[i] + '</span></li>');
	}
	return items;
}

function identifySequence(initial) {
	var identity = seq.identify();

	if (known.hasOwnProperty(identity)) {
		elInfo.html(known[identity]);
	}
	else {
		elInfo.html('Does this sequence <a href="http://oeis.org/search?q=' +
		encodeURIComponent('signed:' + initial.slice(2, 12).join(',')) +
		'&fmt=short" title="Search the OEIS">look familiar</a>?');
	}
}

function useHash() {
	var hash = location.hash;

	if (hash[0] == '#') {
		hash = hash.slice(1);
	}
	elDeal.val(decodeURIComponent(hash));
	refreshSequence();
}
		</script>
	</body>
</html>
