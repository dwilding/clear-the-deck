function buildMachine(f){var e,d,c,g,h,a,l,b=zeroMachine;for(e=0;e<f.length;e++){g=charMachine(0);for(d=0;d<f[e].factors.length;d++){if(typeof f[e].factors[d].term=="object"){a=buildMachine(f[e].factors[d].term)}else{a=charMachine(f[e].factors[d].term)}h=charMachine(0);for(c=0;c<f[e].factors[d].from;c++){h=buildProduct(h,a)}if(f[e].factors[d].to==null){l=buildRepeat(a)}else{l=charMachine(0);for(;c<f[e].factors[d].to;c++){l=buildSum(buildProduct(l,a),charMachine(0))}}g=buildProduct(g,buildProduct(h,l))}b=buildSum(b,buildScale(f[e].coeff,g))}return b}function buildSum(c,a){var b;if(isZeroMachine(c)){b=a}else{if(isZeroMachine(a)){b=c}else{b=machineSum(c,a);b.expanded=c.expanded.concat(a.expanded)}}return b}function buildProduct(e,c){var b,a,d;if(isZeroMachine(e)||isZeroMachine(c)){d=zeroMachine}else{if(isCharMachine0(e)){d=c}else{if(isCharMachine0(c)){d=e}else{d=machineProduct(e,c);d.expanded=[];for(b=0;b<e.expanded.length;b++){for(a=0;a<c.expanded.length;a++){d.expanded.push({coeff:e.expanded[b].coeff*c.expanded[a].coeff,factors:e.expanded[b].factors.concat(c.expanded[a].factors)})}}}}}return d}function buildRepeat(b){var a;if(isZeroMachine(b)){a=charMachine(0)}else{a=machineRepeat(b);a.expanded=[{coeff:1,factors:[b.expanded]}]}return a}function buildScale(d,b){var a,c;if(d==0){c=zeroMachine}else{c=b;if(d>1){c.output=matrixProduct(c.output,[[d]]);for(a=0;a<c.expanded.length;a++){c.expanded[a].coeff*=d}}}return c}function identifyExpression(b){var d,c,a,f=[],e=[];for(d=0;d<b.length;d++){f[d]=identifyFactors(b[d].factors)}for(d=0;d<f.length;d++){if(f[d]!=null){a=b[d].coeff;for(c=d+1;c<f.length;c++){if(f[d]==f[c]){a+=b[c].coeff;f[c]=null}}if(a==1){e.push(f[d])}else{e.push(a.toString()+"*"+f[d])}}}e.sort();return e.join("or")}function identifyFactors(c){var b,a=0,d=[];for(b=0;b<c.length;b++){if(typeof c[b]=="object"){d.push("("+identifyExpression(c[b])+")^?")}else{a+=c[b]}}if(a>0||d.length==0){d.push(a.toString())}d.sort();return d.join("")}function machineSum(c,a){var b={};b.states=c.states+a.states;b.input=matrixConcat(c.input,a.input);b.output=c.output.concat(a.output);b.jump=matrixConcat(c.jump.concat(zeroMatrix(a.states,c.states)),zeroMatrix(c.states,a.states).concat(a.jump));return b}function machineProduct(c,a){var b={};b.states=c.states+a.states;b.input=matrixConcat(c.input,zeroMatrix(1,a.states));b.output=matrixProduct(c.output,matrixProduct(a.input,a.output)).concat(a.output);b.jump=matrixConcat(c.jump.concat(zeroMatrix(a.states,c.states)),matrixProduct(c.output,matrixProduct(a.input,a.jump)).concat(a.jump));return b}function machineRepeat(c){var a,b=matrixProduct(c.input,c.output);machine={};if(b!=0){throw b}machine.states=c.states+1;machine.input=zeroMatrix(1,machine.states);machine.input[0][0]=1;machine.output=zeroMatrix(machine.states,1);machine.output[0][0]=1;a=matrixProduct(c.jump,c.output);machine.jump=matrixConcat(matrixProduct(c.input,a).concat(a),matrixProduct(c.input,c.jump).concat(c.jump));return machine}function charMachine(c){var a,b={};b.states=c+1;b.input=zeroMatrix(1,b.states);b.input[0][0]=1;b.output=zeroMatrix(b.states,1);b.output[c][0]=1;b.jump=zeroMatrix(b.states,b.states);for(a=0;a<c;a++){b.jump[a][a+1]=1}b.expanded=[{coeff:1,factors:[c]}];return b}function isCharMachine0(a){return(a.expanded.length==1&&a.expanded[0].coeff==1&&a.expanded[0].factors.length==1&&a.expanded[0].factors[0]==0)}var zeroMachine={states:1,input:[[0]],output:[[0]],jump:[[0]],expanded:[{coeff:0,factors:[0]}]};function isZeroMachine(a){return(a.expanded.length==1&&a.expanded[0].coeff==0)}function matrixProduct(f,e){var d,c,b,a=[];for(d=0;d<f.length;d++){a[d]=[];for(c=0;c<e[0].length;c++){a[d][c]=0;for(b=0;b<e.length;b++){a[d][c]+=f[d][b]*e[b][c]}}}return a}function matrixConcat(d,c){var b,a=[];for(b=0;b<d.length;b++){a[b]=d[b].concat(c[b])}return a}function zeroMatrix(d,e){var c,b,a=[];for(c=0;c<d;c++){a[c]=[];for(b=0;b<e;b++){a[c][b]=0}}return a}function parseExpression(c,a){var d,b,g=[{}];if(c.str.length==0){throw c}for(b=0;b<g.length;b++){skipSpace(c);try{d=c.i;g[b].coeff=parseNumber(c);skipSpace(c);if(c.str[c.i]!="*"){throw c}c.i++;skipSpace(c)}catch(f){c.i=d;g[b].coeff=1}g[b].factors=[parseFactor(c)];skipSpace(c);while(c.i<c.str.length){if(a&&c.str[c.i]==")"){c.i++;return g}else{if(c.str.slice(c.i,c.i+2).toLowerCase()=="or"){c.i+=2;g.push({});break}else{g[b].factors.push(parseFactor(c));skipSpace(c)}}}}if(a){throw c}return g}function parseFactor(a){var c,b={};if(a.str[a.i]=="("){a.i++;b.term=parseExpression(a,true)}else{if(a.str[a.i]=="."){while(a.str[a.i]=="."){a.i++}b.term=[{coeff:1,factors:[{term:1,from:0}]}]}else{b.term=parseNumber(a)}}if(a.str[a.i]=="^"){a.i++;if(a.str[a.i]=="?"){a.i++;b.from=0;b.to=null}else{b.from=parseNumber(a);if(a.str[a.i]=="-"){a.i++;if(a.str[a.i]=="?"){a.i++;b.to=null}else{c=a.i;b.to=parseNumber(a);if(b.to<b.from){a.i=c;throw a}}}else{b.to=b.from}}}else{b.from=1;b.to=1}return b}function parseNumber(a){var b=a.i;while(a.i<a.str.length){if(48<=a.str.charCodeAt(a.i)&&a.str.charCodeAt(a.i)<=57){a.i++}else{break}}if(a.i==b){throw a}return +a.str.slice(b,a.i)}function skipSpace(a){var b=a.str.slice(a.i).search(/[^\s]/);if(b==-1){a.i=a.str.length}else{a.i+=b}}function Sequence(a){this.expression=parseExpression({str:a,i:0},false)}Sequence.prototype.build=function(){this.machine=buildMachine(this.expression);this.reset()};Sequence.prototype.reset=function(){this.current=this.machine.input};Sequence.prototype.next=function(){var a=matrixProduct(this.current,this.machine.output);this.current=matrixProduct(this.current,this.machine.jump);return a};Sequence.prototype.identify=function(){return identifyExpression(this.machine.expanded)};